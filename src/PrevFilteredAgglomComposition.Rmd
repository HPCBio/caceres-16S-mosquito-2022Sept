```{r, include=FALSE}
# at some point this should be moved into bookdown
source("~/Desktop/hpcbio-git/caceres-16S-mosquito-2022Sept/src/common_code.R", local = knitr::knit_global())
```

```{r}
physeq.prev <- readRDS("~/Desktop/hpcbio-git/caceres-16S-mosquito-2022Sept/results/phyloseq.prevfiltered.RDS")
```

# Composition plots (filtered data)

Let's look at the taxonomic composition now that the data is filtered. 

```{r}
#Get relative abundance
physeq.prev.prop <- transform_sample_counts(physeq.prev, function(x) x/sum(x) )
sample_data(physeq.prev.prop)$SampleSums <- sample_sums(physeq.prev)

physeq.prev.prop <- physeq.prev.prop %>% tax_fix(unknowns = c(" unidentified"," uncultured", " Clostridiaceae_bacterium", " Clostridium_sp.", " uncultured_bacterium", " uncultured_prokaryote", " unidentified_eubacterium"))

physeq.plot <- physeq.prev.prop
```

Overall compositional summary (stacked bar plots) for all prevalence filtered and tip agglomerated samples.  In this example, just the top 10 ASVs are included.

```{r, results='asis', fig.keep='all', message = FALSE, warning = FALSE, echo = FALSE}
ranks <- c("Class", "Order", "Family", "Genus", "Species")
plots <- lapply(ranks, function (x) { 

  #Plot relative abundance
  p <- plot_bar(physeq.plot, x="Label", fill = x)
  p <- comp_barplot(physeq.plot, x, n_taxa = 20, facet_by = "Env_Comp_Den", palette = dittoSeq::dittoColors())
  p1 <- p + theme(legend.key.size = unit(0.25, 'cm'), #change legend key size
        legend.title = element_text(size=6), #change legend title font size
        legend.text = element_text(size=6),
        axis.title.x=element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
        ylab("Relative Abundance") +
        guides(fill = guide_legend(nrow = 30))
      #  facet_grid(.~trt, scales = "free_x", space = "free_x")

 p1
 f1 <- paste("../results/final-plots/taxa-rank-" , x , "_barplot_top20_splitby_Env_Comp_Den.pdf", sep = "")
 ggsave(f1, device = "pdf")
 #, width = 14, height = 8, device = "pdf"
})


names(plots) <- ranks

# Build list of outputs
# See https://stackoverflow.com/questions/9469504/access-and-preserve-list-names-in-lapply-function for example
# not sure if there is an easy way to make a function out of these.
output <- list()
for(rank in ranks){
  # Header for iteration, note Rmd heading ranks and adjust accordingly
  output[[length(output) + 1L]] <- paste0("## ", rank)

  # Plot
  output[[length(output) + 1L]] <- plots[[rank]]
}

# Render the outputs
for(j in 1:length(output)){
  x <- output[[j]]

  if(inherits(x, "character")){
    cat("\n")
    cat(x)
  } else if(inherits(x, "knitr_kable")){
    cat("\n")
    print(x)
  }
  else {
    # print the html piece of the htmlwidgets
    cat("\n")
    cat(htmltools::renderTags(as_widget(x))$html)
  }
}
```

```{r echo=FALSE, messages=FALSE, warning=FALSE}
# Attach the Dependencies since they do not get included with renderTags(...)$html
deps <- lapply(
  Filter(f = function(x){inherits(x,"htmlwidget")}, x = output),
  function(hw){
    htmltools::renderTags(hw)$dependencies
  }
)
htmltools::attachDependencies(x = htmltools::tagList(), value = unlist(deps,recursive=FALSE))
```
